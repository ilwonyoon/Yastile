function loadUrl(a,b){a=a+"?t="+(new Date).getTime();var c;try{c=new XMLHttpRequest}catch(d){try{c=new ActiveXObject("Msxml2.XMLHTTP")}catch(d){try{c=new ActiveXObject("Microsoft.XMLHTTP")}catch(d){b({})}}}c.onreadystatechange=function(){if(4==c.readyState){var a=JSON.parse(c.responseText);b(a)}},c.open("GET",a,!0),c.send()}function random(){var a=1e4*Math.sin(randomSeed++);return a-Math.floor(a)}function Maybe(a,b){isNaN(b)&&(b=1),random()<=b&&a()}var canvas,ctx,map=[],sprites=[],DIRECTION={LEFT:37,UP:38,RIGHT:39,DOWN:40,LEFTDOWN:3740,RIGHTDOWN:3940,NONE:0},DIRECTION_OPPOSITE={LEFT:DIRECTION.RIGHT,UP:DIRECTION.DOWN,RIGHT:DIRECTION.LEFT,DOWN:DIRECTION.UP},ANIMATION={PUSH_RIGHT:"PushRight",PUSH_LEFT:"PushLeft"},GameObject=function(a){var b=!1;for(var c in a)this[c]=a[c],"function"==typeof a[c]&&(b=!0);this.setDefault("canMove",!1),this.setDefault("canBeCollected",!0),this.setDefault("canFall",!1),this.setDefault("isStableSurface",!0),this.spriteIndex=this.id,a.spriteIndex&&(this.spriteIndex=a.spriteIndex),this.spriteIndexes=a.spriteIndexes,this.animationFrames={},a.animationRight&&(this.animationFrames[DIRECTION.RIGHT]=a.animationRight),a.animationLeft&&(this.animationFrames[DIRECTION.LEFT]=a.animationLeft),a.animationUp&&(this.animationFrames[DIRECTION.UP]=a.animationUp),a.animationDown&&(this.animationFrames[DIRECTION.DOWN]=a.animationDown),this.inActive=!(this.canMove||this.canFall||b),GameObjects[this.id]=this,GameObjects[this.code]=this};GameObject.prototype.getAnimationFrame=function(a,b){var c=this.spriteIndex,d=this.animationFrames[a];return d||(d=this["animation"+a]),d&&d.length>b&&(c=d[b]),sprites[c]},GameObject.prototype.getStaticFrame=function(){var a=this.spriteIndex;return this.spriteIndexes&&this.spriteIndexes.length>0&&(a=this.spriteIndexes[Math.floor(Math.random()*this.spriteIndexes.length)]),a},GameObject.prototype.isEmpty=function(){return 0==this.id},GameObject.prototype.isPlayer=function(){return this.id==GameObjects.PLAYER.id},GameObject.prototype.setDefault=function(a,b){"undefined"==typeof this[a]&&(this[a]=b)},GameObject.prototype.canMoveTo=function(a,b){var c=a.gameObject;if(c.isEmpty())return!0;if(this.isPlayer()&&c.canBeCollected)return!0;if(c.isPlayer()&&a.moveDirection){var d=DIRECTION_OPPOSITE[a.moveDirection];if(b!=d)return!0}return!1};var MapObject=function(a,b){this.gameObject=a,this.id=a.id,this.index=b,this.staticFrame=a.getStaticFrame(),this.left=b%Game.getLevel().width,this.top=Math.floor(b/Game.getLevel().width),this.tileSize=Game.getTileSize(),this.tickOffset=this.tileSize/Game.getTargetTicksPerSecond()};MapObject.prototype.isVisible=function(a){return this.left>=a.tileX-1&&this.left<a.tileX+Game.getViewPort().width+1&&this.top>=a.tileY-1&&this.top<a.tileY+Game.getViewPort().height+1},MapObject.prototype.render=function(a,b){var c=(this.left-b.tileX)*this.tileSize,d=(this.top-b.tileY)*this.tileSize;if(this.moveDirection==DIRECTION.DOWN&&(d+=a*this.tickOffset),this.moveDirection==DIRECTION.UP&&(d-=a*this.tickOffset),this.moveDirection==DIRECTION.LEFT&&(c-=a*this.tickOffset),this.moveDirection==DIRECTION.RIGHT&&(c+=a*this.tickOffset),c+=b.x*a,d+=b.y*a,this.id>0){var e;e=this.animation?this.gameObject.getAnimationFrame(this.animation,a):sprites[this.staticFrame],ctx.drawImage(e,c,d)}},MapObject.prototype.process=function(){if(!this.processed){var a,b=this,c=b.gameObject;if(!c.inActive){if(this.id==GameObjects.PLAYER.id)Input.isDown()&&this.moveIfPossible(DIRECTION.DOWN),Input.isUp()&&this.moveIfPossible(DIRECTION.UP),Input.isLeft()&&this.moveIfPossible(DIRECTION.LEFT),Input.isRight()&&this.moveIfPossible(DIRECTION.RIGHT),this.isMoving()||(Input.isRight()&&(a=this.getObject(DIRECTION.RIGHT),a.gameObject.canBePushed&&a.gameObject.canBePushed.horizontal&&(this.animation=ANIMATION.PUSH_RIGHT,!a.canMove(DIRECTION.RIGHT)||a.gameObject.canFall&&a.canMove(DIRECTION.DOWN)||Maybe(function(){a.move(DIRECTION.RIGHT),b.move(DIRECTION.RIGHT)},1-a.gameObject.canBePushed.friction))),Input.isLeft()&&(a=this.getObject(DIRECTION.LEFT),a.gameObject.canBePushed&&a.gameObject.canBePushed.horizontal&&(this.animation=ANIMATION.PUSH_LEFT,!a.canMove(DIRECTION.LEFT)||a.gameObject.canFall&&a.canMove(DIRECTION.DOWN)||Maybe(function(){a.move(DIRECTION.LEFT),b.move(DIRECTION.LEFT)},1-a.gameObject.canBePushed.friction))));else if(c.canFall&&this.moveIfPossible(DIRECTION.DOWN),!this.isMoving()&&c.canFall&&!this.getObject(DIRECTION.DOWN).gameObject.isStableSurface){var d=this.canMove(DIRECTION.LEFTDOWN),e=this.canMove(DIRECTION.RIGHTDOWN);d&&e&&this.move(Game.getRandomHorizontalDirection()),this.isMoving()||(d&&this.move(DIRECTION.LEFT),e&&this.move(DIRECTION.RIGHT))}this.wasMoving()&&!this.isMoving()&&this.wasMovingToDirection==DIRECTION.DOWN&&c.onFallen&&c.onFallen(this.getObject(DIRECTION.DOWN)),this.isMoving()||c.eachStep&&c.eachStep(this),this.processed=!0}}},MapObject.prototype.fullStep=function(){if(this.next){for(key in this.next)this[key]=this.next[key];this.gameObject=GameObjects[this.id],this.staticFrame=this.gameObject.getStaticFrame(),this.wasMovingToDirection=this.movingInToDirection,this.id==GameObjects.PLAYER.id&&Map.setPlayerObject(this)}else this.wasMovingToDirection=void 0;this.reset()},MapObject.prototype.reset=function(){this.moveDirection=void 0,this.next=void 0,this.movingInToDirection=void 0,this.animation=!1,this.processed=!1},MapObject.prototype.setNext=function(a,b){this.next=this.next||{},this.next[a]=b},MapObject.prototype.getObject=function(a){switch(a){case DIRECTION.DOWN:return map[this.index+Game.getLevel().width];case DIRECTION.UP:return map[this.index-Game.getLevel().width];case DIRECTION.LEFT:return map[this.index-1];case DIRECTION.RIGHT:return map[this.index+1];case DIRECTION.LEFTDOWN:return map[this.index-1+Game.getLevel().width];case DIRECTION.RIGHTDOWN:return map[this.index+1+Game.getLevel().width]}},MapObject.prototype.canMove=function(a){if(this.isMoving())return!1;var b;if(a>100){if(a==DIRECTION.LEFTDOWN){var c=this.getObject(DIRECTION.LEFT),d=this.getObject(DIRECTION.LEFTDOWN);if(c.next||d.next)return!1;if(this.gameObject.canMoveTo(c,DIRECTION.LEFT)&&this.gameObject.canMoveTo(d,DIRECTION.DOWN))return!0}if(a==DIRECTION.RIGHTDOWN){var e=this.getObject(DIRECTION.RIGHT),d=this.getObject(DIRECTION.RIGHTDOWN);if(e.next||d.next)return!1;if(this.gameObject.canMoveTo(e,DIRECTION.RIGHT)&&this.gameObject.canMoveTo(d,DIRECTION.DOWN))return!0}}else{var b=this.getObject(a);if(b){if(b.next&&b.next.id)return!1;if(this.gameObject.canMoveTo(b,a))return!0}else console.error("could not get object in direction"+a,this)}return!1},MapObject.prototype.canMoveLeft=function(){return this.canMove(DIRECTION.LEFT)},MapObject.prototype.canMoveRight=function(){return this.canMove(DIRECTION.RIGHT)},MapObject.prototype.canMoveUp=function(){return this.canMove(DIRECTION.UP)},MapObject.prototype.canMoveDown=function(){return this.canMove(DIRECTION.DOWN)},MapObject.prototype.isMoving=function(){return!!this.moveDirection},MapObject.prototype.wasMoving=function(){return!!this.wasMovingToDirection},MapObject.prototype.sameDirection=function(){return this.wasMovingToDirection},MapObject.prototype.move=function(a){this.moveDirection=a,this.setNext("id",0),this.animation=a;var b=this.getObject(a);b.setNext("id",this.id),b.movingInToDirection=a},MapObject.prototype.moveIfPossible=function(a){this.canMove(a)&&this.move(a)},MapObject.prototype.turnIfPossible=function(){},MapObject.prototype.moveLeftIfPossible=function(){this.moveIfPossible(DIRECTION.LEFT)},MapObject.prototype.moveRightIfPossible=function(){this.moveIfPossible(DIRECTION.RIGHT)},MapObject.prototype.moveUpIfPossible=function(){this.moveIfPossible(DIRECTION.UP)},MapObject.prototype.moveDownIfPossible=function(){this.moveIfPossible(DIRECTION.DOWN)},MapObject.prototype.animate=function(a){this.animation=a};var Game=function(){function a(){var b=k.originalViewPortWidth*k.tileSize,c=window.innerHeight/window.innerWidth,d=c*b;k.viewPortHeight=Math.ceil(d/k.tileSize),canvas.width=b,canvas.height=d,k.showOnScreenControls&&Input.setTouchControllerPosition(),navigator.isCocoonJS||(canvas.style.width=window.innerWidth+"px",canvas.style.height=window.innerHeight+"px"),window.addEventListener("resize",a,!1)}function b(a){var d=a-p;d>u&&(c(),j=1e3/(a-p),p=a),i=1e3/(a-q),q=a,k.showFPS&&g(),requestAnimFrame(b)}function c(){if(0==w){v++,v>=s&&(v=0),0==v&&d();var a=Map.getScrollOffset();e(v,a),v==s-1&&f()}}function d(){var a=Map.getPlayerObject();a&&a.process();for(var b=0,c=l.height*l.width;c>b;b++){var d=map[b];d.process()}Map.initScroll()}function e(a,b){ctx.fillStyle=m,ctx.fillRect(0,0,canvas.width,canvas.height);var c=0-b.tileX*h+b.x*a,d=0-b.tileY*h+b.y*a;ctx.drawImage(n,c,d);for(var e=0,f=l.height*l.width;f>e;e++){var g=map[e];g.isVisible(b)&&g.render(a,b)}var i=Map.getPlayerObject();i&&i.render(a,b),Input.drawTouchController()}function f(){for(var a=0,b=l.height*l.width;b>a;a++){var c=map[a];c.fullStep()}Map.fullStep()}function g(){var a=0;if(!isNaN(j)){t.push(j),t.length>60&&t.shift();for(var b=0,c=0;c<t.length;c++)b+=t[c];a=Math.round(b/t.length)}ctx.fillStyle="Black",ctx.fillRect(0,0,200,30),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText(Math.round(i)+" frames/s , "+Math.round(j)+" ticks/s + ("+a+")",10,26)}var h,i,j,k,l,m,n,o={},p=0,q=0,r=35,s=4,t=[],u=1e3/r,v=0,w=0;return o.init=function(c){if(k=c,randomSeed=(new Date).getTime(),k.seed=randomSeed,canvas=document.createElement("canvas"),navigator.isCocoonJS,ctx=canvas.getContext("2d"),c.showOnScreenControls&&Input.addTouchController(),c.scaleToFit)k.originalViewPortWidth=c.viewPortWidth,k.originalViewPortHeight=c.viewPortHeight,a();else{var d=c.viewPortWidth*c.tileSize,e=c.viewPortHeight*c.tileSize;canvas.width=d,canvas.height=e}document.body.appendChild(canvas),h=c.tileSize,c.borderScrollOffset=4,GameObjects.init(),Map.init(c),loadResources(c.spriteSheet,function(){m=ctx.createPattern(sprites[28],"repeat");var a=new Image;a.onload=function(){n=document.createElement("canvas"),n.width=2048,n.height=1024;var d=n.getContext("2d");d.globalAlpha=.5,d.drawImage(a,0,0),l=c.level,l&&("random"==l.map?(map=Map.generateRandom(l),b()):Map.loadFromUrl(l.map,function(){b()}))},a.src="resources/back.jpg"})},o.getTileSize=function(){return h},o.getTargetTicksPerSecond=function(){return s},o.getViewPort=function(){return{width:k.viewPortWidth,height:k.viewPortHeight}},o.getLevel=function(){return l},o.setLevel=function(a){l=a},o.getSettings=function(){return k},o.getRandomDirection=function(){return DIRECTION.LEFT+Math.floor(4*random())},o.getRandomHorizontalDirection=function(){return random()<=.5?DIRECTION.LEFT:DIRECTION.RIGHT},o.getDirectionTurnedLeft=function(a){var b=a-1;return b<DIRECTION.LEFT&&(b=DIRECTION.DOWN),b},o.getDirectionTurnedRight=function(a){var b=a+1;return b>DIRECTION.DOWN&&(b=DIRECTION.LEFT),b},o.getDirectionName=function(a){switch(a){case DIRECTION.LEFT:return"Left";case DIRECTION.RIGHT:return"Right";case DIRECTION.UP:return"Up";case DIRECTION.DOWN:return"Down";default:return"none"}},o}(),Input=function(){function a(a){var b=a.keyCode;b==l.down&&(c=!0),b==l.left&&(e=!0),b==l.right&&(f=!0),b==l.up&&(d=!0)}function b(a){var b=a.keyCode;b==l.down&&(c=!1),b==l.left&&(e=!1),b==l.right&&(f=!1),b==l.up&&(d=!1),b==l.up}var c,d,e,f,g,h={},i=!1,j={top:170,left:10},k=!1,l={left:37,up:38,right:39,down:40};document.addEventListener("keydown",a,!1),document.addEventListener("keyup",b,!1),h.addTouchController=function(){g=new Image,g.onload=function(){i=!0},g.src="resources/controller.png",h.setTouchControllerPosition(),canvas.addEventListener("mousedown",m,!1),canvas.addEventListener("mousemove",n,!1),canvas.addEventListener("mouseup",o,!1),canvas.addEventListener("touchstart",m,!1),canvas.addEventListener("touchmove",n,!1),canvas.addEventListener("touchend",o,!1)},h.setTouchControllerPosition=function(){j.top=canvas.height-150,j.left=10};var m=function(a){k=!0;var b,c;a.touches&&a.touches.length>0?(b=a.touches[0].clientX,c=a.touches[0].clientY):(b=a.pageX,c=a.pageY),p(b,c)},n=function(a){if(k){var b,c;a.touches&&a.touches.length>0?(b=a.touches[0].clientX,c=a.touches[0].clientY):(b=a.pageX,c=a.pageY),p(b,c)}},o=function(){k=!1,e=!1,f=!1,d=!1,c=!1},p=function(a,b){var g=j.left-10,h=g+130,i=j.top-10,k=i+130,l=(g+h)/2,m=(k+i)/2;a>g&&h>a&&b>i&&k>b&&(e=!1,f=!1,d=!1,c=!1,l-20>a&&(e=!0),a>l+20&&(f=!0),m-20>b&&(d=!0),b>m+20&&(c=!0))};return h.drawTouchController=function(){i&&ctx.drawImage(g,j.left,j.top)},h.isDown=function(){return c},h.isUp=function(){return d},h.isLeft=function(){return e},h.isRight=function(){return f},h}(),Map=function(){var a,b={},c=0,d=0,e=0,f=0,g=0,h=10,i=10,j=4;b.init=function(a){i=a.viewPortHeight,h=a.viewPortWidth,j=a.borderScrollOffset},b.getScrollOffset=function(){return{x:c,y:d,tileX:e,tileY:f}},b.setPlayerObject=function(b){a=b},b.getPlayerObject=function(){return a},b.initScroll=function(){a&&(e+h-a.left<j&&a.moveDirection==DIRECTION.RIGHT&&k(DIRECTION.LEFT),a.left-e<j&&a.moveDirection==DIRECTION.LEFT&&k(DIRECTION.RIGHT),f+i-a.top<j&&a.moveDirection==DIRECTION.DOWN&&k(DIRECTION.UP),a.top-f<j&&a.moveDirection==DIRECTION.UP&&k(DIRECTION.DOWN))};var k=function(a){switch(g=a,c=0,d=0,a){case DIRECTION.LEFT:c=-8;break;case DIRECTION.RIGHT:c=8;break;case DIRECTION.DOWN:d=8;break;case DIRECTION.UP:d=-8}};return b.fullStep=function(){switch(g){case DIRECTION.LEFT:e++;break;case DIRECTION.RIGHT:e--;break;case DIRECTION.DOWN:f--;break;case DIRECTION.UP:f++}g=DIRECTION.NONE,c=0,d=0},b.generateRandom=function(a){map=[];for(var b=Math.random()*(a.width-2)+1,c=Math.random()*(a.height-2)+1,d=Math.floor(c*a.width+b),g=0,h=a.height*a.width;h>g;g++){var i=GameObjects.GRASS;Math.random()<.2&&(i=GameObjects.STONEWALL),Math.random()<.2&&(i=GameObjects.APPLE);var j=g%a.width,k=Math.floor(g/a.width);(0==j||j==a.width-1)&&(i=GameObjects.WALL),(0==k||k==a.height-1)&&(i=GameObjects.WALL),g==d&&(i=GameObjects.PLAYER,e=Math.max(j-10,0),f=Math.max(k-10,0));var l=new MapObject(i,g);map.push(l)}return map},b.parse=function(a){map=[];var b=0,c=1;a.mapStructure&&a.mapStructure.charCount&&(c=a.mapStructure.charCount);for(var d=a.map.length,g=0;d>g;g++)for(var h=a.map[g],i=h.length/c,j=0;i>j;j++){b=g*i+j;for(var k="",l=0;c>l;l++)k+=h[j*c+l];var m=GameObjects[k]||GameObjects.EMPTYSPACE,n=new MapObject(m,b);m.id==GameObjects.PLAYER.id&&(Map.setPlayerObject(n),e=Math.max(j-10,0),f=Math.max(g-10,0)),map.push(n)}return map},b.loadFromUrl=function(a,c){loadUrl(a,function(a){Game.setLevel(a),map=b.parse(a),c&&c()})},b}(),loadResources=function(a,b){var c=new Image;c.onload=function(){for(var a=Game.getSettings().tileSize,d=Math.floor(c.width/a)*Math.floor(c.height/a),e=0;d>e;e++){var f=new Sprite(e,c);sprites.push(f)}b&&b()},c.src=a},Sprite=function(a,b){var c=Game.getSettings().tileSize,d=Math.floor(b.width/c),e=document.createElement("canvas");e.width=c,e.height=c;var f=e.getContext("2d"),g=a%d,h=Math.floor(a/d);return f.drawImage(b,g*c,h*c,c,c,0,0,c,c),e},requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(function(){a(+new Date)},1e3/60)}}(),cancelAnimFrame=function(){return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||function(a){window.clearTimeout(a)}}();window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}();var randomSeed=1,GameObjects=function(){var a={};return a.init=function(){a.EMPTYSPACE=new GameObject({id:0,code:"  "}),a.STONEWALL=new GameObject({id:2,code:"Ww",spriteIndex:2,canBePickedUp:!1}),a.STEELWALL=new GameObject({id:14,code:"Ws",spriteIndexes:[14,4,5,6,7],canBePickedUp:!1}),a.GRASS=new GameObject({id:15,code:"..",spriteIndex:15}),a.EMERALD=new GameObject({id:3,code:"$1",spriteIndex:3}),a.BOULDER=new GameObject({id:26,code:"rr",spriteIndex:26,canBePickedUp:!1,canFall:!0,onFallen:function(){},canBePushed:{vertical:!1,horizontal:!0,friction:.5},isStableSurface:!1}),a.PLAYER=new GameObject({id:9,code:"P1",canMove:!0,spriteIndex:9,animationRight:[11,12,13,12],animationLeft:[16,17,18,17],animationUp:[19,20,21,20],animationDown:[8,9,10,9],animationPushRight:[11,12,13,12],animationPushLeft:[16,17,18,17]}),a.YAM=new GameObject({id:23,code:"Yd",canMove:!0,canBePickedUp:!1,eachStep:function(a){a.moveIfPossible(a.wasMoving()?a.sameDirection():Game.getRandomDirection())}}),a.SPIDER=new GameObject({id:54,code:"Bu",canMove:!0,canBePickedUp:!1,animationRight:[56,57,58,59],animationLeft:[60,61,62,63],animationUp:[51,52,53,52],animationDown:[49,48,50,48],animationRotateUpToRight:[68,69,70,71],animationRotateUpToLeft:[68,69,70,71],animationRotateRightToUp:[68,69,70,71],animationRotateRightToDown:[68,69,70,71],animationRotateDownToLeft:[68,69,70,71],animationRotateDownToRight:[68,69,70,71],animationRotateLeftToUp:[68,69,70,71],animationRotateLeftToDown:[68,69,70,71],turn:function(a,b){var c="Rotate"+Game.getDirectionName(a.wasMovingToDirection)+"To"+Game.getDirectionName(b);a.setNext("movingInToDirection",b),a.setNext("hasTurned",!0),a.animate(c),a.isTurning=!0},eachStep:function(b){if(b.hasTurned&&(b.setNext("hasTurned",!1),b.moveIfPossible(b.sameDirection())),b.wasMoving()&&!b.isMoving()){var c=Game.getDirectionTurnedRight(b.wasMovingToDirection);if(b.canMove(c))a.SPIDER.turn(b,c);else if(b.moveIfPossible(b.sameDirection()),!b.isMoving()){var d=Game.getDirectionTurnedLeft(b.wasMovingToDirection);b.canMove(d)?a.SPIDER.turn(b,d):a.SPIDER.turn(b,c)}}b.isMoving()||b.isTurning||b.moveIfPossible(Game.getRandomDirection())}})},a}();window.addEventListener("load",function(){Game.init({spriteSheet:"resources/VX.png",tileSize:32,viewPortWidth:15,viewPortHeight:15,scaleToFit:!0,showFPS:!0,showOnScreenControls:!0,level:{width:64,height:32,map:"resources/levels/level1.json"}})},!1);