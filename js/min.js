function loadUrl(a,b){a=a+"?t="+(new Date).getTime();var c;try{c=new XMLHttpRequest}catch(d){try{c=new ActiveXObject("Msxml2.XMLHTTP")}catch(d){try{c=new ActiveXObject("Microsoft.XMLHTTP")}catch(d){b({})}}}c.onreadystatechange=function(){if(4==c.readyState){var a=JSON.parse(c.responseText);b(a)}},c.open("GET",a,!0),c.send()}function random(){var a=1e4*Math.sin(randomSeed++);return a-Math.floor(a)}function Maybe(a,b){isNaN(b)&&(b=1),random()<=b&&a()}var canvas,ctx,map=[],sprites=[],DIRECTION={LEFT:37,UP:38,RIGHT:39,DOWN:40,LEFTDOWN:3740,RIGHTDOWN:3940,NONE:0},DIRECTION_OPPOSITE={LEFT:DIRECTION.RIGHT,UP:DIRECTION.DOWN,RIGHT:DIRECTION.LEFT,DOWN:DIRECTION.UP},ANIMATION={PUSH_RIGHT:"PushRight",PUSH_LEFT:"PushLeft",PUSH_UP:"PushUp",PUSH_DOWN:"PushDown"},SCALING={NONE:0,FIT_WIDTH:1,FIT_HEIGHT:2,CONTAIN:3,STRETCH:4},GameObject=function(a){var b=!1;for(var c in a)this[c]=a[c],"function"==typeof a[c]&&(b=!0);if(this.setDefault("canMove",!1),this.setDefault("canBeCollected",!1),this.setDefault("canFall",!1),this.setDefault("isStableSurface",!0),this.spriteIndex=this.id,a.spriteIndex&&(this.spriteIndex=a.spriteIndex),this.spriteIndexes=a.spriteIndexes,this.animationFrames={},a.animationRight&&(this.animationFrames[DIRECTION.RIGHT]=a.animationRight),a.animationLeft&&(this.animationFrames[DIRECTION.LEFT]=a.animationLeft),a.animationUp&&(this.animationFrames[DIRECTION.UP]=a.animationUp),a.animationDown&&(this.animationFrames[DIRECTION.DOWN]=a.animationDown),this.inActive=!(this.canMove||this.canFall||b),GameObjects[this.id]=this,GameObjects[this.code]=this,this.alias)if("string"==typeof this.alias)GameObjects[this.alias]=this;else for(var d=0;d<this.alias.length;d++)GameObjects[this.alias[d]]=this};GameObject.prototype.getAnimationFrame=function(a,b){var c=this.spriteIndex;if(a){var d=Math.min(b,a.length-1);c=a[d]}return sprites[c]},GameObject.prototype.getStaticFrame=function(){var a=this.spriteIndex;return this.spriteIndexes&&this.spriteIndexes.length>0&&(a=this.spriteIndexes[Math.floor(Math.random()*this.spriteIndexes.length)]),a},GameObject.prototype.isEmpty=function(){return 0==this.id},GameObject.prototype.isPlayer=function(){return this.id==GameObjects.PLAYER.id},GameObject.prototype.setDefault=function(a,b){"undefined"==typeof this[a]&&(this[a]=b)},GameObject.prototype.canMoveTo=function(a,b){var c=a.gameObject;if(c.isEmpty())return!0;if(this.isPlayer()&&c.canBeCollected)return!0;if(c.isPlayer()&&a.moveDirection){var d=DIRECTION_OPPOSITE[a.moveDirection];if(b!=d)return!0}return!1};var MapPosition=function(a,b){this.gameObject=a,this.id=a.id,this.index=b,this.staticFrame=a.getStaticFrame(),this.left=b%Game.getLevel().width,this.top=Math.floor(b/Game.getLevel().width),this.tileSize=Game.getTileSize(),this.tickOffset=this.tileSize/Game.getTargetTicksPerSecond()};MapPosition.prototype.isVisible=function(a){return this.left>=a.tileX-1&&this.left<a.tileX+Game.getViewPort().width+1&&this.top>=a.tileY-1&&this.top<a.tileY+Game.getViewPort().height+1},MapPosition.prototype.render=function(a,b){var c=(this.left-b.tileX)*this.tileSize,d=(this.top-b.tileY)*this.tileSize;c+=b.x*a,d+=b.y*a;var e=c,f=d;if(this.moveDirection==DIRECTION.DOWN&&(d+=a*this.tickOffset),this.moveDirection==DIRECTION.UP&&(d-=a*this.tickOffset),this.moveDirection==DIRECTION.LEFT&&(c-=a*this.tickOffset),this.moveDirection==DIRECTION.RIGHT&&(c+=a*this.tickOffset),this.bottomlayer&&(g=sprites[this.bottomlayer],ctx.drawImage(g,e,f)),this.id>0){var g;g=this.animation?this.gameObject.getAnimationFrame(this.animation,a+this.animationStartFrame):sprites[this.staticFrame],ctx.drawImage(g,c,d)}this.toplayer&&(g=sprites[this.toplayer],ctx.drawImage(g,e,f))},MapPosition.prototype.process=function(){if(!this.processed){var a,b=this,c=b.gameObject;if(!c.inActive){if(this.id==GameObjects.PLAYER.id){var d,e,f,g,a;Input.isDown()&&(d=this.moveIfPossible(DIRECTION.DOWN)),Input.isUp()&&(e=this.moveIfPossible(DIRECTION.UP)),Input.isLeft()&&(f=this.moveIfPossible(DIRECTION.LEFT)),Input.isRight()&&(g=this.moveIfPossible(DIRECTION.RIGHT)),a=d||e||f||g,a&&a.gameObject.onCollect&&a.gameObject.onCollect(a),this.isMoving()||(Input.isRight()&&(a=this.getObject(DIRECTION.RIGHT),a.gameObject.canBePushed&&a.gameObject.canBePushed.horizontal&&(this.animate(ANIMATION.PUSH_RIGHT),!a.canMove(DIRECTION.RIGHT)||a.gameObject.canFall&&a.canMove(DIRECTION.DOWN)||Maybe(function(){a.move(DIRECTION.RIGHT),b.move(DIRECTION.RIGHT)},1-a.gameObject.canBePushed.friction))),Input.isLeft()&&(a=this.getObject(DIRECTION.LEFT),a.gameObject.canBePushed&&a.gameObject.canBePushed.horizontal&&(this.animate(ANIMATION.PUSH_LEFT),!a.canMove(DIRECTION.LEFT)||a.gameObject.canFall&&a.canMove(DIRECTION.DOWN)||Maybe(function(){a.move(DIRECTION.LEFT),b.move(DIRECTION.LEFT)},1-a.gameObject.canBePushed.friction))),Input.isUp()&&(a=this.getObject(DIRECTION.UP),a.gameObject.canBePushed&&a.gameObject.canBePushed.vertical&&(this.animate(ANIMATION.PUSH_UP),a.canMove(DIRECTION.UP)&&Maybe(function(){a.move(DIRECTION.UP),b.move(DIRECTION.UP)},1-a.gameObject.canBePushed.friction))),Input.isDown()&&(a=this.getObject(DIRECTION.DOWN),a.gameObject.canBePushed&&a.gameObject.canBePushed.vertical&&(this.animate(ANIMATION.PUSH_DOWN),a.canMove(DIRECTION.DOWN)&&Maybe(function(){a.move(DIRECTION.DOWN),b.move(DIRECTION.DOWN)},1-a.gameObject.canBePushed.friction))))}else if(c.canFall&&this.moveIfPossible(DIRECTION.DOWN),!this.isMoving()&&c.canFall&&!this.getObject(DIRECTION.DOWN).gameObject.isStableSurface){var h=this.canMove(DIRECTION.LEFTDOWN),i=this.canMove(DIRECTION.RIGHTDOWN);h&&i&&this.move(Game.getRandomHorizontalDirection()),this.isMoving()||(h&&this.move(DIRECTION.LEFT),i&&this.move(DIRECTION.RIGHT))}this.wasMoving()&&!this.isMoving()&&this.wasMovingToDirection==DIRECTION.DOWN&&c.onFallen&&c.onFallen(this,this.getObject(DIRECTION.DOWN)),c.eachStep&&c.eachStep(this),this.processed=!0}}},MapPosition.prototype.fullStep=function(a){if(this.next){for(key in this.next)this[key]=this.next[key];this.gameObject=GameObjects[this.id],this.staticFrame=this.gameObject.getStaticFrame(),this.wasMovingToDirection=this.movingInToDirection,this.id==GameObjects.PLAYER.id&&Map.setPlayerObject(this),this.animation=!1}else this.wasMovingToDirection=void 0;this.animation&&(this.animation.length>this.animationStartFrame+a+1?this.animationStartFrame=this.animationStartFrame+a+1:this.animation=!1),this.reset(),this.action&&(this.action(this),this.action=void 0)},MapPosition.prototype.reset=function(){this.moveDirection=void 0,this.next=void 0,this.movingInToDirection=void 0,this.processed=!1},MapPosition.prototype.setNext=function(a,b){this.next=this.next||{},this.next[a]=b},MapPosition.prototype.getObject=function(a){switch(a){case DIRECTION.DOWN:return map[this.index+Game.getLevel().width];case DIRECTION.UP:return map[this.index-Game.getLevel().width];case DIRECTION.LEFT:return map[this.index-1];case DIRECTION.RIGHT:return map[this.index+1];case DIRECTION.LEFTDOWN:return map[this.index-1+Game.getLevel().width];case DIRECTION.RIGHTDOWN:return map[this.index+1+Game.getLevel().width]}},MapPosition.prototype.canMove=function(a){if(this.isMoving())return!1;var b;if(a>100){if(a==DIRECTION.LEFTDOWN){var c=this.getObject(DIRECTION.LEFT),d=this.getObject(DIRECTION.LEFTDOWN);if(c.next||d.next)return!1;if(this.gameObject.canMoveTo(c,DIRECTION.LEFT)&&this.gameObject.canMoveTo(d,DIRECTION.DOWN))return!0}if(a==DIRECTION.RIGHTDOWN){var e=this.getObject(DIRECTION.RIGHT),d=this.getObject(DIRECTION.RIGHTDOWN);if(e.next||d.next)return!1;if(this.gameObject.canMoveTo(e,DIRECTION.RIGHT)&&this.gameObject.canMoveTo(d,DIRECTION.DOWN))return!0}}else{var b=this.getObject(a);if(b){if(b.next&&b.next.id)return!1;if(this.gameObject.canMoveTo(b,a))return!0}else console.error("could not get object in direction"+a,this)}return!1},MapPosition.prototype.canMoveLeft=function(){return this.canMove(DIRECTION.LEFT)},MapPosition.prototype.canMoveRight=function(){return this.canMove(DIRECTION.RIGHT)},MapPosition.prototype.canMoveUp=function(){return this.canMove(DIRECTION.UP)},MapPosition.prototype.canMoveDown=function(){return this.canMove(DIRECTION.DOWN)},MapPosition.prototype.isMoving=function(){return!!this.moveDirection},MapPosition.prototype.wasMoving=function(){return!!this.wasMovingToDirection},MapPosition.prototype.sameDirection=function(){return this.wasMovingToDirection},MapPosition.prototype.move=function(a){this.moveDirection=a,this.setNext("id",0),this.animate(a);var b=this.getObject(a);return b.setNext("id",this.id),b.setNext("_objectProperties",this._objectProperties),b.movingInToDirection=a,b},MapPosition.prototype.moveIfPossible=function(a){return this.canMove(a)?this.move(a):!1},MapPosition.prototype.moveLeftIfPossible=function(){this.moveIfPossible(DIRECTION.LEFT)},MapPosition.prototype.moveRightIfPossible=function(){this.moveIfPossible(DIRECTION.RIGHT)},MapPosition.prototype.moveUpIfPossible=function(){this.moveIfPossible(DIRECTION.UP)},MapPosition.prototype.moveDownIfPossible=function(){this.moveIfPossible(DIRECTION.DOWN)},MapPosition.prototype.animate=function(a){"string"==typeof a||"number"==typeof a?(this.animation=this.gameObject[a],this.animation||(this.animation=this.gameObject["animation"+a]),this.animation||(this.animation=this.gameObject.animationFrames[a]),this.animation||(this.animation=this.gameObject.animationFrames["animation"+a])):this.animation=a,this.animationStartFrame=0},MapPosition.prototype.animateIfPossible=function(a){this.isAnimating()||this.animate(a)},MapPosition.prototype.isAnimating=function(){return this.animation},MapPosition.prototype.refresh=function(){this.setNext("id",this.id)},MapPosition.prototype.transformInto=function(a,b,c){this.setNext("id",a.id),b&&this.animate(b),c&&this.setNext("action",c)},MapPosition.prototype.addLayer=function(a,b){"bottom"==b?this.bottomlayer=a:this.toplayer=a},MapPosition.prototype.objectProperties=function(){return this._objectProperties=this._objectProperties||{},this._objectProperties};var Game=function(){function a(){var b=m.originalViewPortWidth*m.tileSize,c=m.originalViewPortHeight*m.tileSize,d=window.innerHeight/window.innerWidth;switch(m.scaling){case SCALING.FIT_WIDTH:c=d*b;break;case SCALING.FIT_HEIGHT:d=window.innerWidth/window.innerHeight,b=d*c;break;case SCALING.CONTAIN:var e=Math.ceil(d*b/m.tileSize);e<m.originalViewPortHeight?(d=window.innerWidth/window.innerHeight,b=d*c):c=d*b}if(m.viewPortWidth=Math.ceil(b/m.tileSize),m.viewPortHeight=Math.ceil(c/m.tileSize),canvas.width=b,canvas.height=c,p&&p.setPosition(),q&&q.setPosition(),navigator.isCocoonJS)UI.setScale(1,1);else{ctx.webkitImageSmoothingEnabled=ctx.imageSmoothingEnabled=ctx.mozImageSmoothingEnabled=ctx.oImageSmoothingEnabled=!1,canvas.style.width=window.innerWidth+"px",canvas.style.height=window.innerHeight+"px";var f=parseInt(canvas.style.width)/canvas.width,g=parseInt(canvas.style.height)/canvas.height;UI.setScale(f,g)}window.addEventListener("resize",a,!1)}function b(a){var d=a-s;d>x&&(c(),l=1e3/(a-s),s=a),k=1e3/(a-t),t=a,m.showScore&&i(),m.showFPS&&h(),requestAnimFrame(b)}function c(){C()}function d(){y++,y>=v&&(y=0),0==y&&e();var a=Map.getScrollOffset();f(y,a),y==v-1&&g(y)}function e(){var a=Map.getPlayerObject();a&&a.process();for(var b=Map.getLevelProperties(),c=0,d=b.height*b.width;d>c;c++){var e=map[c];e.process()}Map.initScroll()}function f(a,b){ctx.fillStyle=n,ctx.fillRect(0,0,canvas.width,canvas.height);var c=0-b.tileX*j+b.x*a,d=0-b.tileY*j+b.y*a;ctx.drawImage(o,c,d);for(var e=Map.getLevelProperties(),f=0,g=e.height*e.width;g>f;f++){var h=map[f];h.isVisible(b)&&h.render(a,b)}var i=Map.getPlayerObject();i&&i.render(a,b),UI.renderElements()}function g(a){for(var b=Map.getLevelProperties(),c=0,d=b.height*b.width;d>c;c++){var e=map[c];e.fullStep(a)}Map.fullStep(a)}function h(){var a=0;if(!isNaN(l)){w.push(l),w.length>60&&w.shift();for(var b=0,c=0;c<w.length;c++)b+=w[c];a=Math.round(b/w.length)}ctx.fillStyle="Black",ctx.fillRect(0,0,200,30),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText(Math.round(k)+" frames/s , "+Math.round(l)+" ticks/s + ("+a+")",10,26)}function i(){ctx.fillStyle="Black",ctx.fillRect(0,30,200,30),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText("Score: "+z,10,56)}var j,k,l,m,n,o,p,q,r={},s=0,t=0,u=35,v=4,w=[],x=1e3/u,y=-1,z=0,A=0,B=!1,C=function(){};return r.init=function(c){if(m=c,randomSeed=(new Date).getTime(),m.seed=randomSeed,canvas=document.createElement("canvas"),navigator.isCocoonJS,ctx=canvas.getContext("2d"),c.scaling)m.originalViewPortWidth=c.viewPortWidth,m.originalViewPortHeight=c.viewPortHeight,a();else{var d=c.viewPortWidth*c.tileSize,e=c.viewPortHeight*c.tileSize;canvas.width=d,canvas.height=e}document.body.appendChild(canvas),j=c.tileSize,c.borderScrollOffset=4,UI.init(),GameObjects.init(),Map.init(c),loadResources(c.spriteSheet,function(){n=ctx.createPattern(sprites[28],"repeat");var a=new Image;a.onload=function(){o=document.createElement("canvas"),o.width=2048,o.height=1024;var d=o.getContext("2d");d.globalAlpha=.5,d.drawImage(a,0,0),c.start?c.start():c.level?r.loadLevel(c.level):console.error("nothing to do!"),b()},a.src="resources/back.jpg"})},r.start=function(){UI.removeAllElements(),m.showOnScreenControls&&(p=new UI.GameController(m.onScreenControlsImage),UI.addElement(p)),q=new UI.Button("resources/close_button.png"),q.onClick=function(){r.exit()},UI.addElement(q),r.setGameSection(d)},r.exit=function(){Intro.init()},r.loadLevel=function(a){console.error("loading level ",a),"string"==typeof a?Map.loadFromUrl(a,function(){r.start()}):"random"==a.map&&(map=Map.generateRandom(a),r.start())},r.getTileSize=function(){return j},r.getTargetTicksPerSecond=function(){return v},r.getViewPort=function(){return{width:m.viewPortWidth,height:m.viewPortHeight}},r.getLevel=function(){return level},r.setLevel=function(a){level=a},r.getSettings=function(){return m},r.getRandomDirection=function(){return DIRECTION.LEFT+Math.floor(4*random())},r.getRandomHorizontalDirection=function(){return random()<=.5?DIRECTION.LEFT:DIRECTION.RIGHT},r.getDirectionTurnedLeft=function(a){var b=a-1;return b<DIRECTION.LEFT&&(b=DIRECTION.DOWN),b},r.getDirectionTurnedRight=function(a){var b=a+1;return b>DIRECTION.DOWN&&(b=DIRECTION.LEFT),b},r.getDirectionName=function(a){switch(a){case DIRECTION.LEFT:return"Left";case DIRECTION.RIGHT:return"Right";case DIRECTION.UP:return"Up";case DIRECTION.DOWN:return"Down";default:return"none"}},r.setTargetScore=function(a){A=a},r.addScore=function(a){z+=a},r.hasTargetScore=function(){return z>=A},r.isWon=function(a){return a&&(B=a),B&&console.error("WON!"),B},r.setGameSection=function(a){C=a},r}(),Input=function(){function a(a){var b=a.keyCode;b==h.down&&(c=!0),b==h.left&&(e=!0),b==h.right&&(f=!0),b==h.up&&(d=!0)}function b(a){var b=a.keyCode;b==h.down&&(c=!1),b==h.left&&(e=!1),b==h.right&&(f=!1),b==h.up&&(d=!1),b==h.up}var c,d,e,f,g={},h={left:37,up:38,right:39,down:40};return document.addEventListener("keydown",a,!1),document.addEventListener("keyup",b,!1),g.isDown=function(a){return"undefined"!=typeof a&&(c=a),c},g.isUp=function(a){return"undefined"!=typeof a&&(d=a),d},g.isLeft=function(a){return"undefined"!=typeof a&&(e=a),e},g.isRight=function(a){return"undefined"!=typeof a&&(f=a),f},g}(),Map=function(){var a,b,c,d={},e=0,f=0,g=0,h=0,i=0,j=10,k=10,l=4;d.init=function(a){k=a.viewPortHeight,j=a.viewPortWidth,l=a.borderScrollOffset},d.getScrollOffset=function(){return{x:e,y:f,tileX:g,tileY:h}},d.setPlayerObject=function(a){c=a},d.getPlayerObject=function(){return c},d.initScroll=function(){c&&(g+j-c.left<l&&c.moveDirection==DIRECTION.RIGHT&&m(DIRECTION.LEFT),c.left-g<l&&c.moveDirection==DIRECTION.LEFT&&m(DIRECTION.RIGHT),h+k-c.top<l&&c.moveDirection==DIRECTION.DOWN&&m(DIRECTION.UP),c.top-h<l&&c.moveDirection==DIRECTION.UP&&m(DIRECTION.DOWN))};var m=function(a){switch(i=a,e=0,f=0,a){case DIRECTION.LEFT:e=-8;break;case DIRECTION.RIGHT:e=8;break;case DIRECTION.DOWN:f=8;break;case DIRECTION.UP:f=-8}};return d.fullStep=function(){switch(i){case DIRECTION.LEFT:g++;break;case DIRECTION.RIGHT:g--;break;case DIRECTION.DOWN:h--;break;case DIRECTION.UP:h++}i=DIRECTION.NONE,e=0,f=0},d.generateRandom=function(c){console.error("random map"),map=[],a=c.width,b=c.height;for(var d=Math.random()*(a-2)+1,e=Math.random()*(b-2)+1,f=Math.floor(e*a+d),i=0,j=b*a;j>i;i++){var k=GameObjects.KEY,l=i%a,m=Math.floor(i/a);(0==l||l==a-1)&&(k=GameObjects.STEELWALL),(0==m||m==b-1)&&(k=GameObjects.STEELWALL),i==f&&(k=GameObjects.PLAYER,g=Math.max(l-10,0),h=Math.max(m-10,0));var n=new MapPosition(k,i);map.push(n)}return map},d.parse=function(c){map=[];var d=0,e=1;c.mapStructure&&c.mapStructure.charCount&&(e=c.mapStructure.charCount),Game.setTargetScore(c.minimumScore||0),b=c.map.length;for(var f=0;b>f;f++){var i=c.map[f];a=i.length/e;for(var j=0;a>j;j++){d=f*a+j;for(var k="",l=0;e>l;l++)k+=i[j*e+l];var m=GameObjects[k]||GameObjects.EMPTYSPACE,n=new MapPosition(m,d);m.id==GameObjects.PLAYER.id&&(Map.setPlayerObject(n),g=Math.max(j-10,0),h=Math.max(f-10,0)),map.push(n)}}return map},d.loadFromUrl=function(a,b){loadUrl(a,function(a){Game.setLevel(a),map=d.parse(a),b&&b()})},d.getLevelProperties=function(){return{width:a,height:b}},d}(),loadResources=function(a,b){var c=new Image;c.onload=function(){for(var a=Game.getSettings().tileSize,d=Math.floor(c.width/a)*Math.floor(c.height/a),e=0;d>e;e++){var f=new Sprite(e,c,Game.getSettings().tileSize);sprites.push(f)}b&&b()},c.src=a},Sprite=function(a,b,c){var d=Math.floor(b.width/c),e=document.createElement("canvas");e.width=c,e.height=c;var f=e.getContext("2d"),g=a%d,h=Math.floor(a/d);return f.drawImage(b,g*c,h*c,c,c,0,0,c,c),e},UI=function(){function a(a){var b,d;a.touches&&a.touches.length>0?(b=a.touches[0].clientX,d=a.touches[0].clientY):(b=a.pageX,d=a.pageY);var e=b/g,f=d/h;c=UI.getEventElement(e,f),i.isTouchDown=!0,i.x=e,i.y=f,i.startX=e,i.startY=f,i.object=c,c&&c.element&&c.element.onDown&&c.element.onDown(i)}function b(a){var b,d;a.touches&&a.touches.length>0?(b=a.touches[0].clientX,d=a.touches[0].clientY):(b=a.pageX,d=a.pageY);var e=b/g,f=d/h;i.x=e,i.y=f,i.isTouchDown&&c&&c.element&&c.element.onDrag&&c.element.onDrag(i)}var c,d,e={},f=[],g=1,h=1,i={};e.init=function(){canvas.addEventListener("mousedown",a,!1),canvas.addEventListener("mousemove",b,!1),canvas.addEventListener("mouseup",j,!1),canvas.addEventListener("touchstart",a,!1),canvas.addEventListener("touchmove",b,!1),canvas.addEventListener("touchend",j,!1)},e.registerEventElement=function(a,b,c,e,f){d.push({element:a,top:c,right:e,bottom:f,left:b})},e.getEventElement=function(a,b){for(var c,e=0,f=d.length;f>e;e++){var g=d[e];a>=g.left&&a<=g.right&&b>=g.top&&b<=g.bottom&&(c=g)}return c},e.clear=function(a){a=a||"Black",ctx.fillStyle=a,ctx.fillRect(0,0,canvas.width,canvas.height),d=[]},e.removeAllElements=function(){f=[]},e.addElement=function(a){f.push(a)},e.renderElements=function(){for(var a=0,b=f.length;b>a;a++){var c=f[a];c.render()}},e.setScale=function(a,b){g=a,h=b};var j=function(){if(c&&c.element){var a=c.element;a.onClick&&a.onClick(i),a.onUp&&a.onUp(i)}c=void 0,i={},Input.isDown(!1),Input.isUp(!1),Input.isLeft(!1),Input.isRight(!1)};return e}(),requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(function(){a(+new Date)},1e3/60)}}(),cancelAnimFrame=function(){return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||function(a){window.clearTimeout(a)}}();window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}();var randomSeed=1,GameObjects=function(){var a={};return a.checkLightBulb=function(a){a.isLightSocket?(a.animateIfPossible("On"),a.objectProperties().isActivated||(a.objectProperties().isActivated=!0,Game.addScore(1),Game.hasTargetScore()&&Game.isWon(!0))):a.objectProperties().isActivated&&(a.objectProperties().isActivated=!1,Game.addScore(-1))},a.init=function(){a.EMPTYSPACE=new GameObject({id:0,code:"  ",alias:" ",canBeCollected:!0}),a.STONEWALL=new GameObject({id:2,code:"Ww",alias:"W",spriteIndex:2}),a.STEELWALL=new GameObject({id:14,code:"Ws",spriteIndexes:[14,4,5,6,7]}),a.GRASS=new GameObject({id:15,code:"..",spriteIndex:15,canBeCollected:!0}),a.EMERALD=new GameObject({id:3,code:"$1",spriteIndex:3,canBeCollected:!0}),a.BOULDER=new GameObject({id:26,code:"rr",spriteIndex:26,spriteIndexes:[24,25,26],canFall:!0,onFallen:function(){},canBePushed:{vertical:!1,horizontal:!0,friction:.5},isStableSurface:!1}),a.PLAYER=new GameObject({id:9,code:"P1",alias:"P",canMove:!0,spriteIndex:9,animationRight:[11,12,13,12],animationLeft:[16,17,18,17],animationUp:[19,20,21,20],animationDown:[8,9,10,9],animationPushRight:[11,12,13,12],animationPushLeft:[16,17,18,17]}),a.YAM=new GameObject({id:23,code:"Yd",canMove:!0,eachStep:function(a){a.moveIfPossible(a.wasMoving()?a.sameDirection():Game.getRandomDirection())}}),a.SPIDER=new GameObject({id:54,code:"Bu",canMove:!0,animationRight:[56,57,58,59],animationLeft:[60,61,62,63],animationUp:[51,52,53,52],animationDown:[49,48,50,48],animationRotateUpToRight:[68,69,70,71],animationRotateUpToLeft:[68,69,70,71],animationRotateRightToUp:[68,69,70,71],animationRotateRightToDown:[68,69,70,71],animationRotateDownToLeft:[68,69,70,71],animationRotateDownToRight:[68,69,70,71],animationRotateLeftToUp:[68,69,70,71],animationRotateLeftToDown:[68,69,70,71],turn:function(a,b){var c="Rotate"+Game.getDirectionName(a.wasMovingToDirection)+"To"+Game.getDirectionName(b);a.setNext("movingInToDirection",b),a.setNext("hasTurned",!0),a.animate(c),a.isTurning=!0},eachStep:function(b){if(b.hasTurned&&(b.setNext("hasTurned",!1),b.moveIfPossible(b.sameDirection())),b.wasMoving()&&!b.isMoving()){var c=Game.getDirectionTurnedRight(b.wasMovingToDirection);if(b.canMove(c))a.SPIDER.turn(b,c);else if(b.moveIfPossible(b.sameDirection()),!b.isMoving()){var d=Game.getDirectionTurnedLeft(b.wasMovingToDirection);b.canMove(d)?a.SPIDER.turn(b,d):a.SPIDER.turn(b,c)}}b.isMoving()||b.isTurning||b.moveIfPossible(Game.getRandomDirection())}}),a.BLOB=new GameObject({id:40,code:"Ro",canMove:!0,animationPulsate:[40,40,41,41,42,42,43,43,44,44,45,45,46,46,47,47],eachStep:function(a){a.isAnimating()||a.animate("Pulsate")}}),a.KEY=new GameObject({id:88,code:"Kg",canBeCollected:!0,animationRotate:[88,88,89,89,90,90,91,91,92,92,93,93,94,94,95,95,96,96,97,97,98,98,99,99,88,88,89,89,90,90,91,91,92,92,93,93,94,94,95,95,96,96,97,97,98,98,99,99],onCollect:function(){a.DOOR.shouldOpen=!0},eachStep:function(a){a.isAnimating()||a.animate("Rotate")}}),a.DOOR=new GameObject({id:72,code:"Dg",eachStep:function(b){!b.isOpen&&this.shouldOpen&&(b.transformInto(a.EMPTYSPACE),b.addLayer(this.id+1))}}),a.EXPLOSION=new GameObject({id:80,code:"**",animationBoom:[80,81,82,83,84,85,86,87],eachStep:function(b){b.isAnimating()||b.transformInto(a.EMPTYSPACE,"Boom")}}),a.BOMB=new GameObject({id:34,code:"Bo",canFall:!0,canBePushed:{vertical:!1,horizontal:!0,friction:0},animationSmash:[35,36,37,38],onFallen:function(b){b.transformInto(a.EXPLOSION,"Smash",function(b){b.transformInto(a.EMERALD,"Boom")})}}),a.LIGHTBULB=new GameObject({id:100,code:"Lb",alias:"o",canBePushed:{vertical:!0,horizontal:!0,friction:0},animationOn:[101,101,102,102,103,103,101,101,102,102,103,103],eachStep:function(b){a.checkLightBulb(b)}}),a.AIRBUBBLE=new GameObject({id:76,code:"La",alias:"a",canBePushed:{vertical:!0,horizontal:!0,friction:0},animationOn:[101,101,102,102,103,103,101,101,102,102,103,103],eachStep:function(b){b.wasMoving()&&b.moveIfPossible(b.sameDirection()),a.checkLightBulb(b)}}),a.LIGHTSOCKET=new GameObject({id:75,code:"Ls",alias:":",eachStep:function(b){b.isAnimating()||(b.transformInto(a.EMPTYSPACE),b.addLayer(this.id,"bottom"),b.isLightSocket=!0)}})},a}(),Intro=function(){function a(a){Game.loadLevel(a.url)}var b={},c=[{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"},{name:"level 1",url:"resources/levels/level1.json"},{name:"Sokoban 1",url:"resources/levels/sokoban1.json"}];return b.init=function(){UI.removeAllElements();var b={items:c,onSelect:function(b){a(b)}},d=new UI.Listbox(b);UI.addElement(d),Game.setGameSection(Intro.levelSelector)},b.levelSelector=function(){UI.clear(),UI.renderElements()},b}();window.addEventListener("load",function(){Game.init({spriteSheet:"resources/VX.png",tileSize:32,viewPortWidth:12,viewPortHeight:12,scaling:SCALING.CONTAIN,showFPS:!0,showOnScreenControls:!0,onScreenControlsImage:"resources/controller_4way.png",showScore:!0,start:Intro.init})},!1);