var canvas,ctx,map=[],sprites=[],DIRECTION={LEFT:37,UP:38,RIGHT:39,DOWN:40,NONE:0},GameObject=function(a){this.id=a.id,this.canMove="undefined"==typeof a.canMove?!1:a.canMove,this.canMoveThrough="undefined"==typeof a.canMoveThrough?!0:a.canMoveThrough,this.spriteIndex=this.id,a.spriteIndex&&(this.spriteIndex=a.spriteIndex),this.spriteIndexes=a.spriteIndexes,this.animationFrames={},a.animationRight&&(this.animationFrames[DIRECTION.RIGHT]=a.animationRight),a.animationLeft&&(this.animationFrames[DIRECTION.LEFT]=a.animationLeft),a.animationUp&&(this.animationFrames[DIRECTION.UP]=a.animationUp),a.animationDown&&(this.animationFrames[DIRECTION.DOWN]=a.animationDown),GameObjects[this.id]=this};GameObject.prototype.getAnimationFrame=function(a,b){var c=this.spriteIndex,d=this.animationFrames[a];return d&&d.length>b&&(c=d[b]),sprites[c]},GameObject.prototype.getStaticFrame=function(){var a=this.spriteIndex;return this.spriteIndexes&&this.spriteIndexes.length>0&&(a=this.spriteIndexes[Math.floor(Math.random()*this.spriteIndexes.length)]),a};var MapObject=function(a,b){this.gameObject=a,this.id=a.id,this.index=b,this.staticFrame=a.getStaticFrame(),this.left=b%Game.getLevel().width,this.top=Math.floor(b/Game.getLevel().width),this.tileSize=Game.getTileSize(),this.tickOffset=this.tileSize/Game.getTargetTicksPerSecond()};MapObject.prototype.isVisible=function(a){return this.left>=a.tileX-1&&this.left<a.tileX+Game.getViewPort().width+1&&this.top>=a.tileY-1&&this.top<a.tileY+Game.getViewPort().height+1},MapObject.prototype.render=function(a,b){var c=(this.left-b.tileX)*this.tileSize,d=(this.top-b.tileY)*this.tileSize;if(this.moveDirection==DIRECTION.DOWN&&(d+=a*this.tickOffset),this.moveDirection==DIRECTION.UP&&(d-=a*this.tickOffset),this.moveDirection==DIRECTION.LEFT&&(c-=a*this.tickOffset),this.moveDirection==DIRECTION.RIGHT&&(c+=a*this.tickOffset),c+=b.x*a,d+=b.y*a,this.id>0){var e;e=this.moveDirection?this.gameObject.getAnimationFrame(this.moveDirection,a):sprites[this.staticFrame],ctx.drawImage(e,c,d)}},MapObject.prototype.process=function(){this.id==GameObjects.PLAYER.id&&(Map.setPlayerObject(this),Input.isDown()&&this.canMove(DIRECTION.DOWN)&&this.move(DIRECTION.DOWN),Input.isUp()&&this.canMove(DIRECTION.UP)&&this.move(DIRECTION.UP),Input.isLeft()&&this.canMove(DIRECTION.LEFT)&&this.move(DIRECTION.LEFT),Input.isRight()&&this.canMove(DIRECTION.RIGHT)&&this.move(DIRECTION.RIGHT))},MapObject.prototype.fullStep=function(){"undefined"!=typeof this.next&&(this.id=this.next,this.gameObject=GameObjects[this.id],this.staticFrame=this.gameObject.getStaticFrame()),this.reset()},MapObject.prototype.reset=function(){this.moveDirection=void 0,this.next=void 0},MapObject.prototype.setNextId=function(a){this.next=a},MapObject.prototype.setId=function(a){this.id=a},MapObject.prototype.getObject=function(a){return a==DIRECTION.DOWN?map[this.index+Game.getLevel().width]:a==DIRECTION.UP?map[this.index-Game.getLevel().width]:a==DIRECTION.LEFT?map[this.index-1]:a==DIRECTION.RIGHT?map[this.index+1]:void 0},MapObject.prototype.canMove=function(a){if(this.moveDirection)return!1;var b=this.getObject(a);return b.next?!1:b.gameObject&&!b.gameObject.canMoveThrough?!1:!0},MapObject.prototype.move=function(a){this.moveDirection=a,this.next=0;var b=this.getObject(a);b.setNextId(this.id),b.setId(0)};var Game=function(){function a(){var b=k.originalViewPortWidth*k.tileSize,c=window.innerHeight/window.innerWidth,d=c*b;k.viewPortHeight=Math.ceil(d/k.tileSize),canvas.width=b,canvas.height=d,k.showOnScreenControls&&Input.setTouchControllerPosition(),navigator.isCocoonJS||(canvas.style.width=window.innerWidth+"px",canvas.style.height=window.innerHeight+"px"),window.addEventListener("resize",a,!1)}function b(a){var d=a-p;d>u&&(c(),j=1e3/(a-p),p=a),i=1e3/(a-q),q=a,k.showFPS&&g(),requestAnimFrame(b)}function c(){if(0==w){v++,v>=s&&(v=0),0==v&&d();var a=Map.getScrollOffset();e(v,a),v==s-1&&f()}}function d(){for(var a=0,b=l.height*l.width;b>a;a++){var c=map[a];c.process()}Map.initScroll()}function e(a,b){ctx.fillStyle=m,ctx.fillRect(0,0,canvas.width,canvas.height);var c=0-b.tileX*h+b.x*a,d=0-b.tileY*h+b.y*a;ctx.drawImage(n,c,d);for(var e=0,f=l.height*l.width;f>e;e++){var g=map[e];g.isVisible(b)&&g.render(a,b)}Input.drawTouchController()}function f(){for(var a=0,b=l.height*l.width;b>a;a++){var c=map[a];c.fullStep()}Map.fullStep()}function g(){var a=0;if(!isNaN(j)){t.push(j),t.length>60&&t.shift();for(var b=0,c=0;c<t.length;c++)b+=t[c];a=Math.round(b/t.length)}ctx.fillStyle="Black",ctx.fillRect(0,0,200,30),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText(Math.round(i)+" frames/s , "+Math.round(j)+" ticks/s + ("+a+")",10,26)}var h,i,j,k,l,m,n,o={},p=0,q=0,r=35,s=4,t=[],u=1e3/r,v=0,w=0;return o.init=function(c){if(k=c,canvas=document.createElement("canvas"),navigator.isCocoonJS,ctx=canvas.getContext("2d"),c.showOnScreenControls&&Input.addTouchController(),c.scaleToFit)k.originalViewPortWidth=c.viewPortWidth,k.originalViewPortHeight=c.viewPortHeight,a();else{var d=c.viewPortWidth*c.tileSize,e=c.viewPortHeight*c.tileSize;canvas.width=d,canvas.height=e}document.body.appendChild(canvas),h=c.tileSize,c.borderScrollOffset=4,GameObjects.init(),Map.init(c),l=c.level,l&&"random"==l.map&&(map=Map.generateRandom(l)),loadResources(c.spriteSheet,function(){m=ctx.createPattern(sprites[28],"repeat");var a=new Image;a.onload=function(){n=document.createElement("canvas"),n.width=2048,n.height=1024;var c=n.getContext("2d");c.globalAlpha=.5,c.drawImage(a,0,0),b()},a.src="resources/back.jpg"})},o.getTileSize=function(){return h},o.getTargetTicksPerSecond=function(){return s},o.getViewPort=function(){return{width:k.viewPortWidth,height:k.viewPortHeight}},o.getLevel=function(){return l},o}(),Input=function(){function a(a){var b=a.keyCode;b==l.down&&(c=!0),b==l.left&&(e=!0),b==l.right&&(f=!0),b==l.up&&(d=!0)}function b(a){var b=a.keyCode;b==l.down&&(c=!1),b==l.left&&(e=!1),b==l.right&&(f=!1),b==l.up&&(d=!1),b==l.up}var c,d,e,f,g,h={},i=!1,j={top:170,left:10},k=!1,l={left:37,up:38,right:39,down:40};document.addEventListener("keydown",a,!1),document.addEventListener("keyup",b,!1),h.addTouchController=function(){g=new Image,g.onload=function(){i=!0},g.src="resources/controller.png",h.setTouchControllerPosition(),canvas.addEventListener("mousedown",m,!1),canvas.addEventListener("mousemove",n,!1),canvas.addEventListener("mouseup",o,!1),canvas.addEventListener("touchstart",m,!1),canvas.addEventListener("touchmove",n,!1),canvas.addEventListener("touchend",o,!1)},h.setTouchControllerPosition=function(){j.top=canvas.height-150,j.left=10};var m=function(a){k=!0;var b,c;a.touches&&a.touches.length>0?(b=a.touches[0].clientX,c=a.touches[0].clientY):(b=a.pageX,c=a.pageY),p(b,c)},n=function(a){if(k){var b,c;a.touches&&a.touches.length>0?(b=a.touches[0].clientX,c=a.touches[0].clientY):(b=a.pageX,c=a.pageY),p(b,c)}},o=function(){k=!1,e=!1,f=!1,d=!1,c=!1},p=function(a,b){var g=j.left-10,h=g+130,i=j.top-10,k=i+130,l=(g+h)/2,m=(k+i)/2;a>g&&h>a&&b>i&&k>b&&(e=!1,f=!1,d=!1,c=!1,l-20>a&&(e=!0),a>l+20&&(f=!0),m-20>b&&(d=!0),b>m+20&&(c=!0))};return h.drawTouchController=function(){i&&ctx.drawImage(g,j.left,j.top)},h.isDown=function(){return c},h.isUp=function(){return d},h.isLeft=function(){return e},h.isRight=function(){return f},h}(),Map=function(){var a,b={},c=0,d=0,e=0,f=0,g=0,h=10,i=10,j=4;b.init=function(a){i=a.viewPortHeight,h=a.viewPortWidth,j=a.borderScrollOffset},b.getScrollOffset=function(){return{x:c,y:d,tileX:e,tileY:f}},b.setPlayerObject=function(b){a=b},b.initScroll=function(){a&&(e+h-a.left<j&&a.moveDirection==DIRECTION.RIGHT&&k(DIRECTION.LEFT),a.left-e<j&&a.moveDirection==DIRECTION.LEFT&&k(DIRECTION.RIGHT),f+i-a.top<j&&a.moveDirection==DIRECTION.DOWN&&k(DIRECTION.UP),a.top-f<j&&a.moveDirection==DIRECTION.UP&&k(DIRECTION.DOWN))};var k=function(a){switch(g=a,c=0,d=0,a){case DIRECTION.LEFT:c=-8;break;case DIRECTION.RIGHT:c=8;break;case DIRECTION.DOWN:d=8;break;case DIRECTION.UP:d=-8}};return b.fullStep=function(){switch(g){case DIRECTION.LEFT:e++;break;case DIRECTION.RIGHT:e--;break;case DIRECTION.DOWN:f--;break;case DIRECTION.UP:f++}g=DIRECTION.NONE,c=0,d=0},b.generateRandom=function(a){map=[];for(var b=Math.random()*(a.width-2)+1,c=Math.random()*(a.height-2)+1,d=Math.floor(c*a.width+b),g=0,h=a.height*a.width;h>g;g++){var i=GameObjects.GRASS;Math.random()<.2&&(i=GameObjects.STONEWALL),Math.random()<.2&&(i=GameObjects.APPLE);var j=g%a.width,k=Math.floor(g/a.width);(0==j||j==a.width-1)&&(i=GameObjects.WALL),(0==k||k==a.height-1)&&(i=GameObjects.WALL),g==d&&(i=GameObjects.PLAYER,e=Math.max(j-10,0),f=Math.max(k-10,0));var l=new MapObject(i,g);map.push(l)}return map},b}(),loadResources=function(a,b){var c=new Image;c.onload=function(){for(var a=0;30>a;a++){var d=new Sprite(a,c);sprites.push(d)}b&&b()},c.src=a},Sprite=function(a,b){var c=document.createElement("canvas");c.width=32,c.height=32;var d=c.getContext("2d"),e=a%8,f=Math.floor(a/8);return d.drawImage(b,32*e,32*f,32,32,0,0,32,32),c},requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(function(){a(+new Date)},1e3/60)}}(),cancelAnimFrame=function(){return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||function(a){window.clearTimeout(a)}}();window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}();var GameObjects=function(){var a={};return a.init=function(){a.EMPTYSPACE=new GameObject({id:0}),a.STONEWALL=new GameObject({id:2,spriteIndex:2,canMoveThrough:!1}),a.WALL=new GameObject({id:14,spriteIndexes:[14,4,5,6,7],canMoveThrough:!1}),a.GRASS=new GameObject({id:15,spriteIndex:15}),a.APPLE=new GameObject({id:3,spriteIndex:3}),a.PLAYER=new GameObject({id:9,canMove:!0,spriteIndex:9,animationRight:[11,12,13,12],animationLeft:[16,17,18,17],animationUp:[19,20,21,20],animationDown:[8,9,10,9]})},a}();window.addEventListener("load",function(){Game.init({spriteSheet:"resources/VX.png",tileSize:32,viewPortWidth:15,viewPortHeight:15,scaleToFit:!0,showFPS:!0,showOnScreenControls:!0,level:{width:64,height:32,map:"random"}})},!1);